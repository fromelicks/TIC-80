name: Create Release

on:
  workflow_dispatch:

jobs:
  fetch-and-release:
    runs-on: ubuntu-latest

    steps:
      # Step 0: auth
      - name: Authenticate GitHub CLI
        run: echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      # Step 1: Checkout the repository
      - name: Checkout Repository
        uses: actions/checkout@v4

      # Step 2: Get the latest successful Build workflow run
      - name: Get Latest Build Workflow
        uses: actions/github-script@v7
        id: fetch_workflow
        with:
          script: |
            const { data } = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'build.yml', // Ensure this matches your Build workflow filename
              status: 'success',
              per_page: 1,
            });

            // data.workflow_runs is the array of runs
            const runs = data.workflow_runs || [];
            if (runs.length === 0) {
              core.setFailed('No successful Build workflow runs found.');
              return;
            }

            const latestRun = runs[0];
            core.setOutput('run_id', String(latestRun.id));
            core.setOutput('run_name', latestRun.name || latestRun.head_branch || String(latestRun.id));

      # Step 3: Download all artifacts from the latest Build workflow
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          run-id: ${{ steps.fetch_workflow.outputs.run_id }}
          path: ./artifacts

      # Step 4: Create a new GitHub Release
      - name: Create a Release
        id: release
        uses: actions/create-release@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag_name: v${{ github.run_number }}
          release_name: Release Build #${{ steps.fetch_workflow.outputs.run_name }}
          body: |
            This release contains the build artifacts from workflow "${{ steps.fetch_workflow.outputs.run_name }}".
          draft: false
          prerelease: false
        # Add output mapping
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: false

      # Step 5: Attach each artifact to the release
      - name: Upload Artifacts to Release
        run: |
          for file in ./artifacts/*; do
            echo "Uploading $file"
            gh release upload "${{ steps.release.outputs.tag_name }}" "$file" --clobber
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
